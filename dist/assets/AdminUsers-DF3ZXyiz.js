import{r as l,j as e,C as F}from"./index-3iRPG9Bu.js";import{b as v,a as b}from"./index.esm-aB2BTCbt.js";import{C as K,a as Q}from"./CCardBody-ZnA988Qk.js";import{C as W}from"./CCardHeader-D5Sem3LH.js";import{C as B}from"./CFormSelect-B25eiRp0.js";import{c as ve}from"./cil-plus-D8mtC-W5.js";import{C as k}from"./CAlert-CS1k0cQ9.js";import{C as he,a as pe,b as R,c as p,d as ue,e as u,g as fe,f as be,h as ie,i as oe,j as ne,k as te,l as le}from"./cil-trash-DC43jLP2.js";import{C as ce}from"./CForm-B3srEGj3.js";import{C as E}from"./CFormInput-BjgXPPX5.js";import"./CFormControlWrapper-DTREpq_c.js";import"./CCloseButton-B86-_tbR.js";import"./useForkedRef-DSh7hi_l.js";import"./TeacherContent-4OZygDT1.js";import"./cil-sun-Cy5DgvOh.js";import"./cil-user-Ddrdy7PS.js";import"./cil-lock-locked-DmxpJbVL.js";var Ne=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M265.614,206.387H456V16H424V149.887L397.863,123.75c-79.539-79.539-208.96-79.54-288.5,0s-79.539,208.96,0,288.5a204.232,204.232,0,0,0,288.5,0l-22.627-22.627c-67.063,67.063-176.182,67.063-243.244,0s-67.063-176.183,0-243.246,176.182-67.063,243.245,0l28.01,28.01H265.614Z' class='ci-primary'/>"],de=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M472.971,122.344,373.656,23.029A23.838,23.838,0,0,0,356.687,16H56A24.028,24.028,0,0,0,32,40V472a24.028,24.028,0,0,0,24,24H456a24.028,24.028,0,0,0,24-24V139.313A23.838,23.838,0,0,0,472.971,122.344ZM320,48v96H176V48ZM448,464H64V48h80V176H352V48h1.373L448,142.627Z' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M252,224a92,92,0,1,0,92,92A92.1,92.1,0,0,0,252,224Zm0,152a60,60,0,1,1,60-60A60.068,60.068,0,0,1,252,376Z' class='ci-primary'/>"],Ee=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M208,16A112.127,112.127,0,0,0,96,128v79.681a80.236,80.236,0,0,0,9.768,38.308l27.455,50.333L60.4,343.656A79.725,79.725,0,0,0,24,410.732V496H312V464H56V410.732a47.836,47.836,0,0,1,21.841-40.246l97.66-63.479-41.64-76.341A48.146,48.146,0,0,1,128,207.681V128a80,80,0,0,1,160,0v79.681a48.146,48.146,0,0,1-5.861,22.985L240.5,307.007,312,353.483V315.317l-29.223-19,27.455-50.334A80.23,80.23,0,0,0,320,207.681V128A112.127,112.127,0,0,0,208,16Z' class='ci-primary'/><polygon fill='var(--ci-primary-color, currentColor)' points='424 400 424 336 392 336 392 400 328 400 328 432 392 432 392 496 424 496 424 432 488 432 488 400 424 400' class='ci-primary'/>"],me=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='427.314 107.313 404.686 84.687 256 233.373 107.314 84.687 84.686 107.313 233.373 256 84.686 404.687 107.314 427.313 256 278.627 404.686 427.313 427.314 404.687 278.627 256 427.314 107.313' class='ci-primary'/>"];const ke=({user:j,classes:T,loading:I})=>{const S=j==null?void 0:j.id,g=j==null?void 0:j.role,[M,y]=l.useState([]),[P,q]=l.useState(""),[_,x]=l.useState(""),[A,U]=l.useState(!1),[V,H]=l.useState(null),[D,O]=l.useState(""),[z,L]=l.useState(!1),N=s=>{if(!s)return"--:-- --";try{const[d,c]=s.split(":"),r=parseInt(d,10),m=r>=12?"PM":"AM";return`${r%12||12}:${c} ${m}`}catch(d){return console.error("Error formateando hora:",d),"--:-- --"}},o=async()=>{if(g===3){L(!0);try{const s=localStorage.getItem("authToken");if(!s)throw new Error("No se encontró token de autenticación");const d=`https://application-backend-4anj.onrender.com/api/studentclass/student/${S}`,c=await fetch(d,{headers:{Authorization:`Bearer ${s}`}});if(!c.ok)throw new Error("Error al obtener clases asignadas");const r=await c.json();console.log("Clases asignadas obtenidas:",r);const m=r.map(w=>({id:w.class_id,specialty_name:w.specialty_name,day:w.day,schedule:`${N(w.start_time)} - ${N(w.end_time)}`,teacher_name:w.teacher_name}));y(m)}catch(s){console.error("Error fetching assigned classes:",s),O(s.message||"Error al cargar clases asignadas")}finally{L(!1)}}};l.useEffect(()=>{o()},[S,g]);const $=async()=>{if(!P){x("Por favor selecciona una clase");return}if(g!==3){x("Solo estudiantes pueden ser asignados a clases");return}try{U(!0),x("");const s=localStorage.getItem("authToken");if(!s)throw new Error("No se encontró token de autenticación");const d=await fetch("https://application-backend-4anj.onrender.com/api/studentclass",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({student_id:S,class_id:parseInt(P)})});if(!d.ok){const c=await d.json();throw new Error(c.error||"Error al asignar clase")}o(),q("")}catch(s){console.error("Error assigning class:",s),x(s.message||"Error al asignar clase")}finally{U(!1)}},t=async s=>{if(window.confirm("¿Estás seguro de eliminar esta clase asignada?"))try{console.log("Eliminando clase asignada:",s),H(s),x("");const d=localStorage.getItem("authToken");if(!d)throw new Error("No se encontró token de autenticación");const c=await fetch("https://application-backend-4anj.onrender.com/api/studentclass",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({student_id:S,class_id:s})});if(!c.ok){const r=await c.json();throw new Error(r.error||"Error al eliminar asignación")}y(r=>r.filter(m=>m.id!==s))}catch(d){console.error("Error deleting class assignment:",d),x(d.message||"Error al eliminar asignación")}finally{H(null)}};return I||z?e.jsxs(K,{children:[e.jsx(W,{children:e.jsx("h5",{children:"Clases Asignadas"})}),e.jsxs(Q,{className:"text-center",children:[e.jsx(F,{}),e.jsx("p",{children:"Cargando clases asignadas..."})]})]}):e.jsxs(K,{children:[e.jsxs(W,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h5",{children:"Clases Asignadas"}),g===3&&e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(B,{value:P,onChange:s=>q(s.target.value),disabled:A,children:[e.jsx("option",{value:"",children:"Seleccionar Clase"}),T.map(s=>e.jsxs("option",{value:s.id,children:[s.specialty_name," - ",s.day," (",N(s.start_time)," a ",N(s.end_time),")"]},s.id))]}),e.jsx(v,{color:"primary",onClick:$,disabled:A,children:A?e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"sm"})," Asignando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{icon:ve})," Asignar"]})})]})]}),e.jsxs(Q,{children:[_&&e.jsx(k,{color:"danger",children:_}),D&&e.jsx(k,{color:"danger",children:D}),g!==3?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{children:"Las clases solo se asignan a estudiantes"})}):M.length===0?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{children:"No hay clases asignadas"})}):e.jsxs(he,{hover:!0,responsive:!0,children:[e.jsx(pe,{children:e.jsxs(R,{children:[e.jsx(p,{children:"ID"}),e.jsx(p,{children:"Especialidad"}),e.jsx(p,{children:"Día"}),e.jsx(p,{children:"Horario"}),e.jsx(p,{children:"Profesor"}),e.jsx(p,{children:"Acciones"})]})}),e.jsx(ue,{children:M.map(s=>e.jsxs(R,{children:[e.jsx(u,{children:s.id}),e.jsx(u,{children:s.specialty_name}),e.jsx(u,{children:s.day}),e.jsx(u,{children:s.schedule}),e.jsx(u,{children:s.teacher_name}),e.jsx(u,{children:e.jsx(v,{color:"danger",size:"sm",onClick:()=>t(s.id),disabled:V===s.id,children:V===s.id?e.jsx(F,{size:"sm"}):e.jsx(b,{icon:fe})})})]},s.id))})]})]})]})},Re=()=>{const[j,T]=l.useState([]),[I,S]=l.useState(!1),[g,M]=l.useState(!1),[y,P]=l.useState(!1),[q,_]=l.useState(""),[x,A]=l.useState(""),[U,V]=l.useState([]),[H,D]=l.useState([]),[O,z]=l.useState(!1),[L,N]=l.useState(!1),[o,$]=l.useState(null),[t,s]=l.useState({}),[d,c]=l.useState(""),[r,m]=l.useState({firstName:"",lastName:"",email:"",password:"",confirmPassword:"",dni:"",role:"",specialty_id:""}),[w,Z]=l.useState({}),J=[{label:"Administrador",value:1},{label:"Profesor",value:2},{label:"Estudiante",value:3}],je=a=>/\S+@\S+\.\S+/.test(a),Y=(a,n=!1)=>{const i={};return a.email?je(a.email)||(i.email="Email inválido"):i.email="Email es requerido",a.role||(i.role="Rol es requerido"),a.role===2&&!a.specialty_id&&(i.especialidad="Especialidad es requerida para profesores"),n||(a.password?a.password!==a.confirmPassword&&(i.confirmPassword="Las contraseñas no coinciden"):i.password="Contraseña es requerida",a.confirmPassword||(i.confirmPassword="Confirma tu contraseña"),a.dni||(i.dni="DNI es requerido")),s(i),Object.keys(i).length===0},xe=a=>{const n=J.find(i=>i.value===a);return n?n.label:"Desconocido"},G=async a=>{try{const n=localStorage.getItem("authToken");if(!n)throw new Error("No se encontró token de autenticación");const i=await fetch(`https://application-backend-4anj.onrender.com/api/specialties/${a}`,{headers:{Authorization:`Bearer ${n}`}});if(!i.ok)throw new Error(`Error al obtener especialidad ${a}`);return(await i.json()).name}catch(n){return console.error(`Error fetching specialty ${a}:`,n),"Especialidad desconocida"}},ee=async()=>{S(!0),_("");try{const a=localStorage.getItem("authToken");if(!a)throw new Error("No se encontró token de autenticación");const n=await fetch("https://application-backend-4anj.onrender.com/api/users",{headers:{Authorization:`Bearer ${a}`}});if(!n.ok)throw new Error("Error al obtener usuarios");const i=await n.json(),f=i.map(h=>({id:h.id,email:h.email,firstName:h.first_name,lastName:h.last_name,dni:h.dni,role:h.role_id,specialty_id:h.specialty_id}));T(f);const C=i.filter(h=>h.role_id===2&&h.specialty_id).map(h=>h.specialty_id),X=[...new Set(C)],re={};for(const h of X)re[h]=await G(h);Z(re)}catch(a){console.error("Error fetching users:",a),_(a.message||"Error al cargar usuarios")}finally{S(!1)}},ae=async()=>{M(!0),_("");try{const a=localStorage.getItem("authToken");if(!a)throw new Error("No se encontró token de autenticación");const n=await fetch("https://application-backend-4anj.onrender.com/api/classes",{headers:{Authorization:`Bearer ${a}`}});if(!n.ok)throw new Error("Error al obtener clases");const i=await n.json();V(i)}catch(a){console.error("Error fetching classes:",a),_(a.message||"Error al cargar clases")}finally{M(!1)}},se=async()=>{P(!0),A("");try{const a=localStorage.getItem("authToken");if(!a)throw new Error("No se encontró token de autenticación");const n=await fetch("https://application-backend-4anj.onrender.com/api/specialties",{headers:{Authorization:`Bearer ${a}`}});if(!n.ok)throw new Error("Error al obtener especialidades");const i=await n.json();D(i)}catch(a){console.error("Error fetching specialties:",a),A(a.message||"Error al cargar especialidades")}finally{P(!1)}};l.useEffect(()=>{ee(),ae(),se()},[]);const ge=async()=>{if(Y(r)){s({}),c("");try{const a=localStorage.getItem("authToken");if(!a)throw new Error("No se encontró token de autenticación");const n=await fetch("https://application-backend-4anj.onrender.com/api/users",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({firstName:r.firstName,lastName:r.lastName,email:r.email,password:r.password,dni:r.dni,role_id:r.role,specialty_id:r.role===2?parseInt(r.specialty_id):null})});if(!n.ok){const f=await n.json();throw new Error(f.error||"Error al crear usuario")}const i=await n.json();if(T([...j,{...i,firstName:i.first_name,lastName:i.last_name,specialty_id:i.specialty_id}]),i.role_id===2&&i.specialty_id){const f=await G(i.specialty_id);Z(C=>({...C,[i.specialty_id]:f}))}c("Usuario creado exitosamente!"),z(!1),m({email:"",password:"",confirmPassword:"",dni:"",role:"",specialty_id:"",firstName:"",lastName:""}),setTimeout(()=>c(""),3e3)}catch(a){s({submit:a.message||"Error al crear usuario"})}}},ye=async()=>{if(Y(o,!0)){s({}),c("");try{const a=localStorage.getItem("authToken");if(!a)throw new Error("No se encontró token de autenticación");const n=await fetch(`https://application-backend-4anj.onrender.com/api/users/${o.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({email:o.email,role_id:o.role,specialty_id:o.role===2?parseInt(o.specialty_id):null})});if(!n.ok){const C=await n.json();throw new Error(C.error||"Error al actualizar usuario")}const i=await n.json(),f={...i,firstName:i.first_name,lastName:i.last_name,specialty_id:i.specialty_id};if(T(j.map(C=>C.id===o.id?f:C)),o.role===2&&o.specialty_id&&!w[o.specialty_id]){const C=await G(o.specialty_id);Z(X=>({...X,[o.specialty_id]:C}))}c("Usuario actualizado exitosamente!"),N(!1),setTimeout(()=>c(""),3e3)}catch(a){s({submit:a.message||"Error al actualizar usuario"})}}},we=async a=>{try{const n=localStorage.getItem("authToken");if(!n)throw new Error("No se encontró token de autenticación");const i=await fetch(`https://application-backend-4anj.onrender.com/api/users/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${n}`}});if(!i.ok){const f=await i.json();throw new Error(f.error||"Error al eliminar usuario")}T(j.filter(f=>f.id!==a)),c("Usuario eliminado exitosamente!"),setTimeout(()=>c(""),3e3)}catch(n){s({submit:n.message||"Error al eliminar usuario"})}},Ce=()=>{ee(),ae(),se()};return e.jsxs(e.Fragment,{children:[e.jsxs(K,{className:"mb-4",children:[e.jsxs(W,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h5",{children:"Gestión de Usuarios"}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(v,{color:"secondary",onClick:Ce,disabled:I||g||y,children:[e.jsx(b,{icon:Ne,className:I||g||y?"spin-icon":""}),I||g||y?" Cargando...":" Actualizar"]}),e.jsxs(v,{color:"primary",onClick:()=>{m({email:"",password:"",confirmPassword:"",dni:"",role:"",specialty_id:"",firstName:"",lastName:""}),z(!0),A(""),s({}),c("")},children:[e.jsx(b,{icon:Ee,className:"me-2"}),"Nuevo Usuario"]})]})]}),e.jsxs(Q,{children:[d&&e.jsx(k,{color:"success",className:"mb-4",children:d}),q&&e.jsx(k,{color:"danger",className:"mb-4",children:q}),I?e.jsx("div",{className:"d-flex justify-content-center my-5",children:e.jsx(F,{})}):e.jsxs(he,{hover:!0,responsive:!0,children:[e.jsx(pe,{children:e.jsxs(R,{children:[e.jsx(p,{children:"Email"}),e.jsx(p,{children:"Nombre"}),e.jsx(p,{children:"Apellido"}),e.jsx(p,{children:"Rol"}),e.jsx(p,{children:"DNI"}),e.jsx(p,{children:"Especialidad"}),e.jsx(p,{children:"Acciones"})]})}),e.jsx(ue,{children:j.map(a=>e.jsxs(R,{children:[e.jsx(u,{children:a.email}),e.jsx(u,{children:a.firstName}),e.jsx(u,{children:a.lastName}),e.jsx(u,{children:xe(a.role)}),e.jsx(u,{children:a.dni}),e.jsx(u,{children:a.role===2&&a.specialty_id?w[a.specialty_id]||"Cargando...":a.role===2&&!a.specialty_id?"Sin especialidad":"-"}),e.jsx(u,{children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(v,{color:"primary",size:"sm",onClick:()=>{$({...a,specialty_id:a.specialty_id}),s({}),c(""),N(!0)},children:e.jsx(b,{icon:be})}),e.jsx(v,{color:"danger",size:"sm",onClick:()=>we(a.id),children:e.jsx(b,{icon:fe})})]})})]},a.id))})]})]})]}),e.jsxs(ie,{visible:O,onClose:()=>z(!1),children:[e.jsx(oe,{children:e.jsx(ne,{children:"Crear Nuevo Usuario"})}),e.jsx(te,{children:e.jsxs(ce,{children:[e.jsx("div",{className:"mb-3",children:e.jsx(E,{label:"Nombre",placeholder:"Juan",value:r.firstName,onChange:a=>m({...r,firstName:a.target.value}),invalid:!!t.firstName,feedback:t.firstName,required:!0})}),e.jsx("div",{className:"mb-3",children:e.jsx(E,{label:"Apellido",placeholder:"Pérez",value:r.lastName,onChange:a=>m({...r,lastName:a.target.value}),invalid:!!t.lastName,feedback:t.lastName,required:!0})}),e.jsx("div",{className:"mb-3",children:e.jsx(E,{type:"email",label:"Email",placeholder:"ejemplo@dominio.com",value:r.email,onChange:a=>m({...r,email:a.target.value}),invalid:!!t.email,feedback:t.email,required:!0})}),e.jsx("div",{className:"mb-3",children:e.jsx(E,{type:"password",label:"Contraseña",value:r.password,onChange:a=>m({...r,password:a.target.value}),invalid:!!t.password,feedback:t.password,required:!r.id})}),e.jsx("div",{className:"mb-3",children:e.jsx(E,{type:"password",label:"Confirmar Contraseña",value:r.confirmPassword,onChange:a=>m({...r,confirmPassword:a.target.value}),invalid:!!t.confirmPassword,feedback:t.confirmPassword,required:!r.id})}),e.jsx("div",{className:"mb-3",children:e.jsx(E,{label:"DNI",placeholder:"12345678",value:r.dni,onChange:a=>m({...r,dni:a.target.value}),invalid:!!t.dni,feedback:t.dni,required:!0})}),e.jsx("div",{className:"mb-3",children:e.jsxs(B,{label:"Rol",value:r.role,onChange:a=>m({...r,role:parseInt(a.target.value),specialty_id:""}),invalid:!!t.role,feedback:t.role,required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar rol"}),J.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})}),r.role===2&&e.jsxs("div",{className:"mb-3",children:[e.jsxs(B,{label:"Especialidad",value:r.specialty_id,onChange:a=>m({...r,specialty_id:a.target.value}),invalid:!!t.especialidad,feedback:t.especialidad,required:r.role===2,disabled:y,children:[e.jsx("option",{value:"",children:"Seleccionar especialidad"}),H.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),y&&e.jsx("small",{className:"text-muted",children:"Cargando especialidades..."}),x&&e.jsx(k,{color:"danger",className:"mt-2 mb-0",children:x})]}),t.submit&&e.jsx(k,{color:"danger",className:"mt-3",children:t.submit})]})}),e.jsxs(le,{children:[e.jsxs(v,{color:"secondary",onClick:()=>z(!1),children:[e.jsx(b,{icon:me,className:"me-2"}),"Cancelar"]}),e.jsxs(v,{color:"primary",onClick:ge,children:[e.jsx(b,{icon:de,className:"me-2"}),"Crear Usuario"]})]})]}),e.jsxs(ie,{size:"lg",visible:L,onClose:()=>N(!1),children:[e.jsx(oe,{children:e.jsx(ne,{children:"Editar Usuario"})}),e.jsx(te,{children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6",children:e.jsxs(ce,{children:[e.jsx("div",{className:"mb-3",children:e.jsx(E,{type:"email",label:"Email",value:(o==null?void 0:o.email)||"",onChange:a=>$({...o,email:a.target.value}),invalid:!!t.email,feedback:t.email,required:!0})}),e.jsx("div",{className:"mb-3",children:e.jsx(E,{label:"DNI",value:(o==null?void 0:o.dni)||"",readOnly:!0})}),e.jsx("div",{className:"mb-3",children:e.jsxs(B,{label:"Rol",value:(o==null?void 0:o.role)||"",onChange:a=>$({...o,role:parseInt(a.target.value),specialty_id:""}),invalid:!!t.role,feedback:t.role,required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar rol"}),J.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})}),(o==null?void 0:o.role)===2&&e.jsxs("div",{className:"mb-3",children:[e.jsxs(B,{label:"Especialidad",value:(o==null?void 0:o.specialty_id)||"",onChange:a=>$({...o,specialty_id:a.target.value}),invalid:!!t.especialidad,feedback:t.especialidad,required:(o==null?void 0:o.role)===2,disabled:y,children:[e.jsx("option",{value:"",children:"Seleccionar especialidad"}),H.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),y&&e.jsx("small",{className:"text-muted",children:"Cargando especialidades..."}),x&&e.jsx(k,{color:"danger",className:"mt-2 mb-0",children:x})]}),t.submit&&e.jsx(k,{color:"danger",children:t.submit})]})}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("h5",{children:"Clases asociadas"}),o&&e.jsx(ke,{user:o,classes:U,loading:g})]})]})}),e.jsxs(le,{children:[e.jsxs(v,{color:"secondary",onClick:()=>N(!1),children:[e.jsx(b,{icon:me,className:"me-2"}),"Cancelar"]}),e.jsxs(v,{color:"primary",onClick:ye,children:[e.jsx(b,{icon:de,className:"me-2"}),"Guardar Cambios"]})]})]}),e.jsx("style",{jsx:!0,children:`
        .spin-icon {
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `})]})};export{Re as default};
